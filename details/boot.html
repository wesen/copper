<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title></title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./intro.html"><strong>1.</strong> Introduction</a></li><li><ul class="section"><li><a href="./audience.html"><strong>1.1.</strong> Audience</a></li><li><a href="./why-rust.html"><strong>1.2.</strong> Why Rust?</a></li><li><a href="./why-arm.html"><strong>1.3.</strong> Why ARM Cortex-M micros?</a></li><li><a href="./what-dev-board.html"><strong>1.4.</strong> What dev board should I use/get?</a></li></ul></li><li><a href="./tools.html"><strong>2.</strong> Setting up a development environment</a></li><li><ul class="section"><li><a href="./linux.html"><strong>2.1.</strong> Linux</a></li><li><a href="./macos.html"><strong>2.2.</strong> macOS</a></li><li><a href="./windows.html"><strong>2.3.</strong> Windows</a></li></ul></li><li><a href="./first/prog.html"><strong>3.</strong> First program</a></li><li><ul class="section"><li><a href="./first/build.html"><strong>3.1.</strong> Build &amp; inspect</a></li><li><a href="./first/qemu.html"><strong>3.2.</strong> Run it under QEMU</a></li><li><a href="./details.html"><strong>3.3.</strong> Nitty-gritty details</a></li><li><ul class="section"><li><a href="./details/target.html"><strong>3.3.1.</strong> Target specification</a></li><li><a href="./details/boot.html" class="active"><strong>3.3.2.</strong> Boot process</a></li><li><a href="./details/ld.html"><strong>3.3.3.</strong> Linker script</a></li></ul></li><li><a href="./first/flash.html"><strong>3.4.</strong> Run it on real hardware</a></li></ul></li><li><a href="./exceptions.html"><strong>4.</strong> Exceptions: Crashing your micro</a></li><li><a href="./blink.html"><strong>5.</strong> Blinking an LED</a></li><li class="spacer"></li><li class="affix">Work In Progress chapters</li><li class="affix"><a href="./optimize.html">(Mis)Optimization</a></li><li class="affix"><a href="registers.html">Zero-cost type-safe register manipulation</a></li><li class="affix"><a href="hal.html">Abstracting Hardware</a></li><li class="affix"><a href="./peripherals.html">Peripherals</a></li><li class="spacer"></li><li class="affix"><a href="./unwritten.html">Unwritten topics</a></li><li class="spacer"></li><li class="affix"><a href="./resources.html">Resources</a></li><li class="affix"><a href="./faq.html">FAQ</a></li><li class="spacer"></li><li class="affix">Published using mdBook</li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <h1>Boot process</h1>
<p>In this section, we'll learn what the microcontroller does right after it's
powered.</p>
<h2>Memory</h2>
<p>But before that, we have to talk a little about the different types of memory
available in a microcontroller. Cortex-M microcontrollers have at least two
different types of memory available to them: Flash memory and Random Access
Memory (RAM).</p>
<p>Flash memory is non-volatile and it's used to store the <code>text</code> section of our
program, i.e. functions and constants. Because this memory is non-volatile, our
program will persist in memory even after the microcontroller is powered off.</p>
<p>RAM, on the other hand, is volatile and it's used to store the <a href="https://en.wikipedia.org/wiki/Call_stack">call stack</a>, the
<a href="https://en.wikipedia.org/wiki/Memory_management#HEAP">heap</a> and static variables. Because RAM is volatile, its contents are lost when
the microcontroller is powered off. Also, when the microcontroller have just
been powered on, its RAM is filled with random values.</p>
<p>These two different memories can be accessed by the processor through the same
32 bit address space. For instance, the LM3S6965 has the following memory
specifications:</p>
<ul>
<li>256 KiB of flash memory. The flash memory region starts at address <code>0x0</code> and
ends at address <code>0x40000</code>.</li>
<li>64 KiB of RAM. The RAM region starts at address <code>0x2000_0000</code> and ends at address <code>0x2001_0000</code>.</li>
</ul>
<h3>Vector table</h3>
<p>On Cortex-M microcontrollers, the beginning of the flash memory holds a data
structure known as the &quot;vector table&quot;. The values stored in the vector table are
used in different hardware processes like the boot process.</p>
<p>The vector table is, effectively, an array of pointers and each of its elements
is used for a different purpose. The vector table is fully documented <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0552a/BABIFJFG.html">here</a>.
But, right now, we are only interested in its first two elements:</p>
<ol>
<li>At <code>0x0</code>: the initial value of the stack pointer.</li>
</ol>
<p>The stack pointer is a register used to track the top of the call stack. The
initial value determines where in memory the call stack will be initialized. As
per the <a href="http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042f/IHI0042F_aapcs.pdf#page=16&amp;zoom=auto,52,151">AAPCS</a> (ARM Architecture Procedure Call Standard), the call
stack grows downwards (towards smaller addresses). That's why the initial value
of the stack pointer is usually set to the largest valid address of the RAM
region.</p>
<ol start="2">
<li>At <code>0x4</code>: the reset vector</li>
</ol>
<p>A &quot;vector&quot; is a pointer to a &quot;handler&quot; and a &quot;handler&quot; is just another name for
a function. Therefore, the reset vector is a (function) pointer to the reset
handler. The reset handler gets called, through the reset vector, whenever a
reset occurs and during the boot process.</p>
<h2>Putting everything together</h2>
<p>Here's what happens during the boot process or whenever the microcontroller is
reset:</p>
<ul>
<li>
<p><code>SP = *(0x0 as *const u32)</code>. The stack pointer, which is a (CPU) register,
is initialized to the value stored at address <code>0x0</code>.</p>
</li>
<li>
<p><code>mem::transmute::&lt;_, fn()&gt;(0x4)()</code>. The reset handler gets called through the
reset vector.</p>
</li>
</ul>
<h2>The takeaway</h2>
<p>What you should remember from all this is that the programs you write for
Cortex-M microcontrollers must comply with a <strong>specific memory layout</strong>. In
particular, the memory section at address <code>0x0</code>, the vector table, must be
properly initialized or your microcontroller won't boot! In the next section,
we'll go over the boot process again using the LM3S6965 as an example.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="./details/target.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="./details/ld.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./details/target.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./details/ld.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
